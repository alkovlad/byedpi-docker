name: Build and Run ciadpi with Docker

on:
  repository_dispatch:
    types: [byedpi_release]

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Create Dockerfile
      run: |
        cat <<EOF > Dockerfile
        FROM alpine:latest

        RUN apk update && apk add --no-cache \
            git \
            build-base \
            cmake \
            openssl-dev \
            libpcap-dev \
            tor

        RUN git clone https://github.com/hufrea/byedpi /opt/byedpi

        WORKDIR /opt/byedpi
        RUN mkdir build && cd build && cmake .. && make

        ENTRYPOINT ["./build/src/ciadpi"]
        EOF

    - name: Build Docker image
      run: docker build -t byedpi .

